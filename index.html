<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ¸ é—œè¥¿ä¹‹æ—… (Live Sync V4) ğŸŒ¸</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
    /* æ¨£å¼å€ (Style) */
    :root { --bg-color: #fff9fb; --primary-pink: #ff9a9e; --soft-pink: #fecfef; --card-bg: #ffffff; --text-color: #5d5d5d; --accent-green: #a8e6cf; --accent-blue: #dcebf7; }
    body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: var(--bg-color); background-image: radial-gradient(var(--soft-pink) 1px, transparent 1px); background-size: 20px 20px; color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
    .container { max-width: 700px; margin: 0 auto; padding-bottom: 80px; }
    header { text-align: center; margin-bottom: 30px; padding: 20px; background: var(--card-bg); border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid var(--primary-pink); }
    h1 { color: var(--primary-pink); margin: 0; font-size: 1.8rem; }
    
    /* è¨­å®šå€é è¨­éš±è— */
    .config-area { background: #f0f0f0; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px dashed #999; text-align: left; display: none;} 
    .config-area input { width: 65%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    .config-area button { width: 30%; background: #333; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;}

    .status-bar { display: inline-block; padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; background: #eee; color: #555; margin-top: 5px; font-weight: bold; }
    .status-sync { background: #d4edda; color: #155724; } 
    .status-working { background: #fff3cd; color: #856404; }
    .status-error { background: #f8d7da; color: #721c24; }

    .btn-group { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    button { border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap;}
    .btn-edit { background: var(--accent-blue); color: #5588a3; }
    .btn-save { background: #28a745; color: white; display: none; }
    .btn-refresh { background: #ff9a9e; color: white; }
    .btn-reset { background: #666; color: white; font-size: 0.8rem; margin-top: 10px; display: none;} 
    body.editing .btn-reset { display: inline-block; } 

    /* Timeline */
    .timeline-item { background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border-left: 5px solid #ddd; position: relative; }
    .date-badge { display: inline-block; background: var(--primary-pink); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; }
    .location-list { list-style: none; padding: 0; margin: 0; }
    .location-item { display: flex; align-items: flex-start; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
    .location-item:last-child { border-bottom: none; }
    
    .time-col { min-width: 70px; font-weight: bold; color: var(--primary-pink); }
    .info-col { flex: 1; }
    .info-col strong { display: block; font-size: 1.05rem; color: #444; }
    .note { font-size: 0.85rem; color: #888; margin-top: 2px; }

    /* Edit Mode */
    body.editing .btn-edit { display: none; }
    body.editing .btn-save { display: inline-block; }
    body.editing input { border: 1px solid #ddd; background: #f9f9f9; padding: 5px; border-radius: 5px; width: 100%; font-family: inherit; margin-bottom: 5px; box-sizing: border-box; }
    body.editing .time-col input { width: 70px; }
    body.editing .delete-btn { display: inline-block; color: #ff5e62; cursor: pointer; margin-left: 10px; font-size: 1.2rem; }
    .delete-btn { display: none; }
    .add-btn-area { text-align: center; display: none; margin-top: 10px; }
    body.editing .add-btn-area { display: block; }
    .btn-add-event { background: transparent; border: 2px dashed #ddd; color: #aaa; width: 100%; padding: 8px; cursor: pointer; }
    .btn-add-event:hover { border-color: var(--primary-pink); color: var(--primary-pink); }
    
    /* Loader & Log */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; display: none;}
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-pink); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #debug-log { display: none; margin-top: 20px; padding: 10px; background: #333; color: #0f0; font-size: 0.8rem; height: 100px; overflow-y: scroll; text-align: left; }
</style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="loader-text">è¼‰å…¥ä¸­...</div>
</div>

<div class="container">
    <header>
        <h1>ğŸŒ¸ é—œè¥¿ä¹‹æ—… (Live Sync V4) ğŸŒ¸</h1>
        
        <div class="config-area" id="config-area">
            <label style="font-size:0.8rem; font-weight:bold;">Apps Script ç¶²å€ï¼š</label><br>
            <input type="text" id="gas-url-input" />
            <button onclick="saveUrlAndConnect()">ğŸ”— é‡è¨­é€£ç·š</button>
        </div>

        <div id="status-bar" class="status-bar">æº–å‚™é€£ç·š...</div>
        
        <div class="btn-group">
            <button class="btn-refresh" onclick="loadData()">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button class="btn-edit" onclick="toggleEditMode()">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
            <button class="btn-save" onclick="saveToGoogle()">â˜ï¸ å„²å­˜è‡³é›²ç«¯</button>
        </div>
        
        <button class="btn-reset" onclick="restoreDefaults()">ğŸ› ï¸ åˆå§‹åŒ–è³‡æ–™ (ä¿®å¾©ç©ºç™½å•é¡Œ)</button>
        <div style="font-size:0.7rem; color:#ccc; margin-top:10px; cursor:pointer;" onclick="toggleConfig()">âš™ï¸ è¨­å®š</div>
    </header>

    <div id="schedule-content"></div>
    
    <div class="add-btn-area">
         <button class="btn-add-event" onclick="addNewDay()" style="border: 2px solid var(--primary-pink); color: var(--primary-pink); font-weight:bold; margin-top:20px;">â• æ–°å¢å…¨æ–°çš„ä¸€å¤©</button>
    </div>

    <div id="debug-log"></div>
</div>

<script>
    // ==========================================
    // âœ… å·²å…§å»ºæ‚¨çš„ç¶²å€
    // ==========================================
    let GAS_URL = "https://script.google.com/macros/s/AKfycbwJUbc4hUPOwrHJaPUITY1NKpq1c25Y0qLSeo79dCx1ZzKW4IdEoj-Rh1qgzRzWQAG5qg/exec"; 

    let scheduleData = [];
    let isEditing = false;
    
    // é è¨­è³‡æ–™ (æ•‘æ´ç”¨)
    const DEFAULT_DATA = [
        {id: 1, day: "1", date: "2/11", time: "06:35", act: "æŠµé”ç¥æˆ¶æ©Ÿå ´", note: "é£›æ©Ÿè½åœ° âœˆï¸"},
        {id: 2, day: "1", date: "2/11", time: "11:00", act: "ä¸‰å®® (åˆé¤)", note: "å¯„æ”¾è¡Œæã€åƒç¥æˆ¶ç‰›? ğŸ¥©"},
        {id: 3, day: "1", date: "2/11", time: "13:00", act: "ç¥æˆ¶è§€å…‰", note: "åŒ—é‡ç•°äººé¤¨è¡—ã€ç¥æˆ¶æ¸¯å¡” ğŸ“¸"},
        {id: 4, day: "1", date: "2/11", time: "15:00", act: "å‰å¾€é¶´æ©‹ Check-in", note: "æ­è»Šå»é£¯åº— ğŸ¨"},
        {id: 5, day: "1", date: "2/11", time: "18:00", act: "æ™šé¤", note: "åœ¨é™„è¿‘åƒæ™šé¤ ğŸœ"},
        {id: 6, day: "2", date: "2/12", time: "10:00", act: "å‡ºç™¼", note: "å‰å¾€ç®•é¢è±é‡ç«™ ğŸšƒ"},
        {id: 7, day: "2", date: "2/12", time: "12:00", act: "åˆé¤", note: "ç®•é¢è±é‡ç«™é™„è¿‘ ğŸ±"},
        {id: 8, day: "2", date: "2/12", time: "13:00", act: "å‹å°¾å¯º", note: "ç¥ˆæ±‚å‹é‹é”æ‘© (ï½14:30) â›©ï¸"},
        {id: 9, day: "2", date: "2/12", time: "15:30", act: "å¿ƒé½‹æ©‹ é€›è¡—", note: "é“é “å €ã€é›£æ³¢å…«é˜ªç¥ç¤¾ ğŸ›ï¸"},
        {id: 10, day: "2", date: "2/12", time: "19:00", act: "æ™šé¤", note: "åƒå¥½åƒçš„ï¼ ğŸ½ï¸"},
        {id: 11, day: "3", date: "2/13", time: "09:00", act: "ç’°çƒå½±åŸ USJ", note: "å…¨æ—¥æš¢ç© (æˆ– å¥ˆè‰¯+å¤§é˜ª) ğŸŒ"},
        {id: 12, day: "4", date: "2/14", time: "07:30", act: "å‡ºç™¼", note: "å‰å¾€äº¬éƒ½ç«™ (08:30æŠµé”) ğŸš…"},
        {id: 13, day: "4", date: "2/14", time: "09:00", act: "ä¼è¦‹ç¨»è·å¤§ç¤¾", note: "åƒæœ¬é³¥å±… (ç´„1å°æ™‚) ğŸ¦Š"},
        {id: 14, day: "4", date: "2/14", time: "12:00", act: "æ¸…æ°´å¯ºã€å…«å‚ç¥ç¤¾", note: "åˆé¤ + é€›è¡— (ç´„4å°æ™‚) ğŸµ"},
        {id: 15, day: "4", date: "2/14", time: "16:00", act: "äºŒæ¢åŸ â†’ é‡‘é–£å¯º", note: "åƒæŠ¹èŒ¶é»å¿ƒ ğŸ¡"},
        {id: 16, day: "4", date: "2/14", time: "18:00", act: "å›å¤§é˜ª", note: "åƒæ™šé¤ ğŸ–"},
        {id: 17, day: "5", date: "2/15", time: "09:00", act: "æ–¹æ¡ˆé¸æ“‡", note: "æ–¹æ¡ˆ1: å¥ˆè‰¯å…¬åœ’ / æ–¹æ¡ˆ2: ç¾è¡“é¤¨ ğŸ¤”"},
        {id: 18, day: "5", date: "2/15", time: "14:00", act: "å¤§é˜ªåŸ", note: "æ­·å²å·¡ç¦® ğŸ¯"},
        {id: 19, day: "5", date: "2/15", time: "15:00", act: "å¸‚å€é€›è¡—", Note: "æœ€å¾Œæ¡è²· ğŸ"},
        {id: 20, day: "6", date: "2/16", time: "10:55", act: "é—œè¥¿æ©Ÿå ´èµ·é£›", note: "å›ç¨‹ âœˆï¸"},
        {id: 21, day: "6", date: "2/16", time: "13:10", act: "æŠµé”æ¡ƒåœ’æ©Ÿå ´", note: "å¹³å®‰å›å®¶ ğŸ "}
    ];

    window.onload = function() {
        // å„ªå…ˆä½¿ç”¨å…§å»ºç¶²å€ï¼Œä½†å¦‚æœä½¿ç”¨è€…ä¹‹å‰æœ‰æ‰‹å‹•è¼¸å…¥éï¼Œå‰‡ä½¿ç”¨ localStorage
        const savedUrl = localStorage.getItem("my_gas_url");
        if(savedUrl) {
            GAS_URL = savedUrl;
        }
        document.getElementById("gas-url-input").value = GAS_URL;
        loadData();
    };

    function saveUrlAndConnect() {
        const url = document.getElementById("gas-url-input").value.trim();
        if(!url.startsWith("https://script.google.com/")) {
            alert("ç¶²å€æ ¼å¼éŒ¯èª¤ï¼"); return;
        }
        localStorage.setItem("my_gas_url", url);
        GAS_URL = url;
        loadData();
    }

    function toggleConfig() {
        const el = document.getElementById('config-area');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function log(msg) {
        console.log(msg);
        const el = document.getElementById('debug-log');
        el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
        if(msg.includes("Error")) el.style.display = "block";
    }

    // æ ¼å¼åŒ– Google Sheet æ™‚é–“ (å°‡ 1899-12-30T... è½‰å› HH:mm)
    function formatTime(val) {
        if(!val) return "";
        if(val.toString().includes(":") && val.toString().length <= 5) return val;
        
        const date = new Date(val);
        if(!isNaN(date.getTime())) {
            let h = date.getHours().toString().padStart(2, '0');
            let m = date.getMinutes().toString().padStart(2, '0');
            return `${h}:${m}`;
        }
        return val;
    }

    // æ ¼å¼åŒ– Google Sheet æ—¥æœŸ (å°‡ 2024-02-11T... è½‰å› 2/11)
    function formatDate(val) {
        if(!val) return "";
        const date = new Date(val);
        if(!isNaN(date.getTime())) {
            return `${date.getMonth()+1}/${date.getDate()}`;
        }
        return val;
    }

    // 1. è®€å–
    function loadData() {
        if(!GAS_URL) return;
        showLoader("æ­£åœ¨ä¸‹è¼‰...");
        updateStatus("é€£ç·šä¸­...", "status-working");
        log("é–‹å§‹è®€å–: " + GAS_URL);

        fetch(GAS_URL + "?action=read")
        .then(res => res.json())
        .then(data => {
            log("è®€å–æˆåŠŸï¼Œç­†æ•¸: " + (Array.isArray(data) ? data.length : "0"));
            
            if (!Array.isArray(data)) data = [];
            
            scheduleData = data.map((row, index) => {
                let safeRow = {};
                Object.keys(row).forEach(k => safeRow[k.toLowerCase()] = row[k]);
                
                return {
                    id: Date.now() + index,
                    day: safeRow.day || "1",
                    date: formatDate(safeRow.date), 
                    time: formatTime(safeRow.time), 
                    act: safeRow.activity || safeRow.act || "",
                    note: safeRow.note || ""
                };
            });
            
            if(scheduleData.length === 0) {
                 updateStatus("ç›®å‰ç„¡è³‡æ–™", "status-working");
                 document.getElementById('schedule-content').innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>ç›®å‰æ²’æœ‰è¡Œç¨‹è³‡æ–™ã€‚<br>è«‹åˆ‡æ›åˆ°ã€Œâœï¸ ç·¨è¼¯æ¨¡å¼ã€ä¸¦é»æ“Šã€ŒğŸ› ï¸ åˆå§‹åŒ–è³‡æ–™ã€æŒ‰éˆ•ã€‚</div>";
            } else {
                 render();
                 updateStatus("â— å·²åŒæ­¥", "status-sync");
            }
            hideLoader();
        })
        .catch(err => {
            hideLoader();
            updateStatus("é€£ç·šå¤±æ•—", "status-error");
            log("è®€å–éŒ¯èª¤: " + err.message);
        });
    }

    // 2. å¯«å…¥
    function saveToGoogle(dataToSave) {
        if(!GAS_URL) return;
        showLoader("æ­£åœ¨å„²å­˜...");
        
        const payload = (dataToSave || scheduleData).map(item => ({
            day: item.day, date: item.date, time: item.time, activity: item.act, note: item.note
        }));

        fetch(GAS_URL + "?action=write", {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(result => {
            hideLoader();
            if(result.status === "success") {
                if(isEditing) toggleEditMode();
                updateStatus("â— å„²å­˜æˆåŠŸ", "status-sync");
                alert("âœ… å„²å­˜æˆåŠŸï¼");
                if(dataToSave) loadData(); 
            } else {
                throw new Error(result.message);
            }
        })
        .catch(err => {
            hideLoader();
            log("å„²å­˜éŒ¯èª¤: " + err.message);
            alert("å„²å­˜å¤±æ•—: " + err.message);
        });
    }

    function restoreDefaults() {
        if(confirm("é€™å°‡æœƒè¦†è“‹ç›®å‰çš„ Google Sheet è³‡æ–™ï¼Œå¯«å…¥ä¸€çµ„é è¨­è¡Œç¨‹ã€‚\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
            saveToGoogle(DEFAULT_DATA);
        }
    }

    function render() {
        const container = document.getElementById('schedule-content');
        container.innerHTML = "";
        
        let daysMap = {};
        scheduleData.forEach(item => {
            if(!daysMap[item.day]) daysMap[item.day] = { date: item.date, items: [] };
            daysMap[item.day].items.push(item);
        });

        const sortedDays = Object.keys(daysMap).sort((a,b) => parseInt(a) - parseInt(b));

        sortedDays.forEach(dayNum => {
            const dayObj = daysMap[dayNum];
            
            // === é—œéµä¿®æ­£ï¼šæ’åºé‚è¼¯ ===
            dayObj.items.sort((a,b) => {
                // å¦‚æœæ™‚é–“æ˜¯ç©ºçš„ï¼ŒæŠŠå®ƒç•¶æˆ "zzzz" (ASCIIç¢¼å¾ˆå¤§)ï¼Œè®“å®ƒæ’åœ¨æœ€å¾Œé¢
                // é€™æ¨£æ–°å¢çš„è¡Œç¨‹å°±ä¸æœƒè·‘åˆ°ä¸­é–“äº†
                const timeA = a.time ? a.time : "zzzz";
                const timeB = b.time ? b.time : "zzzz";
                return timeA.localeCompare(timeB);
            });

            const dayDiv = document.createElement('div');
            dayDiv.className = `timeline-item`;

            let dateVal = dayObj.items[0] ? dayObj.items[0].date : "";
            let dateHtml = `Day ${dayNum} â€¢ ${dateVal}`;
            if(isEditing) {
                dateHtml = `Day ${dayNum} â€¢ <input type="text" value="${dateVal}" style="width:100px; display:inline-block;" onchange="updateDayDate('${dayNum}', this.value)">`;
            }

            let itemsHtml = "";
            dayObj.items.forEach(item => {
                if(isEditing) {
                    itemsHtml += `
                    <li class="location-item">
                        <div class="time-col">
                            <input type="text" value="${item.time}" placeholder="æ™‚é–“" onchange="updateItem(${item.id}, 'time', this.value)">
                        </div>
                        <div class="info-col">
                            <input type="text" value="${item.act}" placeholder="è¡Œç¨‹åç¨±" style="font-weight:bold" onchange="updateItem(${item.id}, 'act', this.value)">
                            <input type="text" value="${item.note}" placeholder="å‚™è¨»" onchange="updateItem(${item.id}, 'note', this.value)">
                        </div>
                        <div class="delete-btn" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</div>
                    </li>`;
                } else {
                    itemsHtml += `
                    <li class="location-item">
                        <div class="time-col">${item.time}</div>
                        <div class="info-col">
                            <strong>${item.act}</strong>
                            <div class="note">${item.note}</div>
                        </div>
                    </li>`;
                }
            });

            let addBtnHtml = "";
            if(isEditing) {
                addBtnHtml = `<div class="add-btn-area"><button class="btn-add-event" onclick="addEventToDay('${dayNum}', '${dateVal}')">â• æ–°å¢è¡Œç¨‹ (å°‡å‡ºç¾åœ¨æœ€ä¸‹æ–¹)</button></div>`;
            }

            dayDiv.innerHTML = `
                <div class="date-badge">${dateHtml}</div>
                <ul class="location-list">${itemsHtml}</ul>
                ${addBtnHtml}
            `;
            container.appendChild(dayDiv);
        });
    }

    function showLoader(msg) { document.getElementById('loader').style.display = 'flex'; document.getElementById('loader-text').innerText = msg; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    function updateStatus(msg, type) { const el = document.getElementById('status-bar'); el.innerText = msg; el.className = 'status-bar ' + (type || ''); }
    function toggleEditMode() { isEditing = !isEditing; document.body.classList.toggle('editing'); render(); }
    function updateItem(id, f, v) { const i = scheduleData.find(x => x.id === id); if(i) i[f] = v; }
    function updateDayDate(d, v) { scheduleData.forEach(i => { if(i.day == d) i.date = v; }); }
    function deleteItem(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { scheduleData = scheduleData.filter(i => i.id !== id); render(); } }
    
    // === é—œéµä¿®æ­£ï¼šæ–°å¢è¡Œç¨‹æ™‚ä¸å¸¶æ™‚é–“ï¼Œä½¿å…¶æ’åœ¨æœ€å¾Œ ===
    function addEventToDay(d, date) { 
        scheduleData.push({ id: Date.now(), day: d, date: date, time: "", act: "æ–°è¡Œç¨‹", note: "" }); 
        render(); 
    }
    
    function addNewDay() { let max = 0; scheduleData.forEach(i => { if(parseInt(i.day) > max) max = parseInt(i.day); }); scheduleData.push({ id: Date.now(), day: (max+1).toString(), date: "æ–°æ—¥æœŸ", time: "09:00", act: "æ–°çš„ä¸€å¤©", note: "" }); render(); setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100); }
</script>

</body>
</html>